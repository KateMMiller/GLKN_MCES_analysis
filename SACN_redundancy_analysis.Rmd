---
output: 
  html_document:
    css: www/styles.css
title: "SACN Redundancy Analysis" 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
options(knitr.kable.NA = '')
options(width = 10)
```

## Lake St. Croix Water Quality Redundancy Analysis {.tabset}
### Background {.tabset}
#### Project Info
This document compares data collected in Lake St. Croix by the Great Lakes Network (GLKN) as part of their <a href="https://www.nps.gov/im/glkn/water-quality-rivers.htm">Water Quality (Rivers)</a> monitoring protocol with data collected by the <a href="https://metrocouncil.org/About-Us/What-We-Do/Departments/Environmental-Services.aspx">Metropolitan Council's Environmental Services (METC) Department</a>. 

METC stations used for this analysis and their code for this analysis are: 
<ul>
<li>Station: SC0003 = METC_STCR_0.3</li>
<li>Station: SC0233 & SC0234 = METC_STCR_23.3</li>
<li>Station: 82000100-08 = METC_STCR_22.5</li>
<li>Station: 82000100-06 = METC_STCR_11.3</li>
<li>Station: 82000100-03 = METC_STCR_16.6</li>
<li>Station: 82000100-05 = METC_STCR_12.4</li>
<li>Station: 82000100-04 = METC_STCR_15.3</li>
<li>Station: 82000100-01 = METC_STCR_22.3</li>
</ul>

For GLKN, we used the most recently published <a href="https://irma.nps.gov/DataStore/Reference/Profile/2309369">2006 -- 2024 Large Rivers Water Quality Monitoring Data</a> Data Package (IRMA record 2309369). For METC, we downloaded all data from 2006 and later from the METC's <a href="https://eims.metc.state.mn.us/AdvancedSearch">Environmental Information Management Systems (EIMS)</a> web server for all monitoring locations within Lake St. Croix. 

Based on the <a href="https://dashboard.waterdata.usgs.gov/app/nwd/en/">USGS National Water Dashboard</a>, Lake St. Croix is bounded by two USGS stream gages, which can be used to model discharge. USGS 05341550 is at the start of Lake St. Croix, very close to METC_STCR_23.3, and is labeled USGS_STCR_23.35; USGS 05344490 is at the confluence near METC_STCR_0.3 and SACN_STCR_2.0 and is labeled USGS_STCR_0.3.   

Except for profile plots, all analyses are based only on surface water samples.

All code use for this analysis are posted on GitHub in the following repository: <a href="https://github.com/KateMMiller/GLKN_MCES_analysis">https://github.com/KateMMiller/GLKN_MCES_analysis</a>

Date report was rendered: `r format(Sys.Date(), "%B %d, %Y")`

Sites included in this analysis are plotted in the map below.
<div class = "toggle"><button>Show Code</button>

```{r chnk2, warning = F, message = F, results = 'hide'}
library(dataRetrieval)
gages <- c("05341550", "05344490")
gage_params <- c("00060", "00010", "00400") # Discharge, Temp, pH
gagedat <- whatNWISdata(siteNumber = gages, parameterCd = gage_params, service = 'dv')[,c("site_no", "parm_cd", "dec_lat_va", "dec_long_va", "begin_date", "end_date")]
gagedat$param[gagedat$parm_cd == "00060"] <- "Discharge"
gagedat$param[gagedat$parm_cd == "00010"] <- "Temp"
gagedat$param[gagedat$parm_cd == "00040"] <- "pH"
gagedat$Location_ID[gagedat$site_no == gages[1]] <- "USGS_STCR_23.35"
gagedat$Location_ID[gagedat$site_no == gages[2]] <- "USGS_STCR_0.3"
gagedat$Org_Code <- "USGS"
names(gagedat)[names(gagedat) == "dec_lat_va"] <- "Latitude"
names(gagedat)[names(gagedat) == "dec_long_va"] <- "Longitude"
# dv = daily values; uv = instantaeous value; qw = water quality
```

```{r chnk3, echo = F, warning = F, message = F, results = 'hide'}
# Code for leaflet map
library(tidyverse)
library(sf)
library(leaflet)
library(leaflet.extras)
library(waterGLKN)
river_zip = "../data/GLKN_water/records-2309369.zip"
importData(type = 'zip', filepath = river_zip)
lksc <- c("SACN_STCR_20.0", "SACN_STCR_15.8", "SACN_STCR_2.0")
sacn_locs <- getLocations(site = lksc) |> select(Location_ID, Org_Code, Latitude, Longitude)
metc_locs1 <- read.csv("./data/local/2025-03-18_1359_56_MCES_EIMS_data.csv") |> 
  select(STATION_ID, X = X_COORDINATE_UTM, Y = Y_COORDINATE_UTM) |> unique() |> 
  mutate(Location_ID = case_when(grepl("SC0003", STATION_ID) ~ as.character("METC_STCR_0.3"),
                                 grepl("SC0233", STATION_ID) ~ as.character("METC_STCR_23.3"),
                                 grepl("SC0234", STATION_ID) ~ as.character("METC_STCR_23.3"),
                                 grepl("82000100-08", STATION_ID) ~ as.character("METC_STCR_22.5"),
                                 grepl("82000100-06", STATION_ID) ~ as.character("METC_STCR_11.3"),
                                 grepl("82000100-03", STATION_ID) ~ as.character("METC_STCR_16.6"),
                                 grepl("82000100-05", STATION_ID) ~ as.character("METC_STCR_12.4"),
                                 grepl("82000100-04", STATION_ID) ~ as.character("METC_STCR_15.3"),
                                 grepl("82000100-01", STATION_ID) ~ as.character("METC_STCR_22.3"))) |>
  filter(!is.na(Location_ID)) 

metc_sf <- st_as_sf(metc_locs1, coords = c("X", "Y"), crs = 32615)
metc_dd <- st_transform(metc_sf, crs = 4269)
metc_locs <- data.frame(Location_ID = metc_dd$Location_ID, 
                        Org_Code = "METC",
                        Latitude = st_coordinates(metc_dd)[,2], 
                        Longitude = st_coordinates(metc_dd)[,1])

samp_locs <- rbind(sacn_locs, metc_locs, gagedat[,c("Location_ID", "Org_Code", "Latitude", "Longitude")])
samp_sf <- st_as_sf(samp_locs, coords = c("Longitude", "Latitude"), crs = 4269)
samp_bb <- st_bbox(samp_sf)
cent_lat <- mean(samp_locs[,"Latitude"])
cent_long <- mean(samp_locs[,"Longitude"])

# leaflet basemaps
NPSbasic <- "https://atlas-stg.geoplatform.gov/styles/v1/atlas-user/ck58pyquo009v01p99xebegr9/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoiYXRsYXMtdXNlciIsImEiOiJjazFmdGx2bjQwMDAwMG5wZmYwbmJwbmE2In0.lWXK2UexpXuyVitesLdwUg"

ESRIimagery <- "http://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"

ESRItopo <- "http://services.arcgisonline.com/arcgis/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}"

ESRINatGeo <- "http://services.arcgisonline.com/arcgis/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}"

# Legend html generator
# Source: https://stackoverflow.com/questions/47064921/leaflet-legend-for-addawesomemarkers-function-with-icons
# Icon library changed from font-awesome to ion

markerLegendHTML <- function(IconSet) {
    # Container div:
    legendHtml <- "<div style='padding: 10px; padding-bottom: 10px;'>
    <h4 style='padding-top:0; padding-bottom:10px; margin: 0; color:#555'> Legend </h4>" #legend title

    n <- 1
    # Add each icon for ion library icons:
    for (Icon in IconSet) {
        if (Icon[["library"]] == "ion") {
        legendHtml<- 
          paste0(legendHtml,
          # marker and marker label div
          "<div style='width: auto; height: 45px; display: flex; align-items: center;'>",
          # awesome marker div
          "<div style='position: relative; display: inline-block; width: 35px; height: 45px;' 
          class='awesome-marker-icon-", Icon[["markerColor"]]," awesome-marker'>",
          # add icons and set color
          # class='ion ion-waterdrop icon-white' selects the correct library, icon, and color
          "<i style='margin-left: 4px; margin-top: 11px' class= 'ion ion-",
            Icon[["icon"]]," icon-", Icon[["iconColor"]],"'></i>",
          "</div><br>", # close awesome marker div
          # legend label div - use name set in IconSet
          "<div style='position: relative; display: inline-block; margin-left: 8px;'>", 
            names(IconSet)[n] ,"</div><br>",
          "</div><br>") # close marker/marker label div    
        }
        n <- n + 1
    } 
    paste0(legendHtml, "</div><br>")
}

# Create list of icons to use in map
IconSet <- awesomeIconList(
  "METC" = makeAwesomeIcon(icon= 'waterdrop', markerColor = 'lightblue', iconColor = 'white', library = "ion"),
  "GLKN" = makeAwesomeIcon(icon= 'waterdrop', markerColor = 'cadetblue', iconColor = 'white', library = "ion"),
  "USGS" = makeAwesomeIcon(icon= 'waterdrop', markerColor = 'green', iconColor = 'white', library = "ion")
)

# Create leaflet map
leaf <- 
leaflet(height = 650, width = 800) |> 
    # set default view of park
    setView(lng = cent_long,
            lat = cent_lat, 
            zoom = 10.25) |> 
    # add map tiles
    addTiles(group="Map", urlTemplate = NPSbasic) |> 
    addTiles(group="Imagery", urlTemplate = ESRIimagery)  |> 
    addTiles(group="Topo", urlTemplate = ESRItopo)  |> 
    addTiles(group="NatGeo", urlTemplate = ESRINatGeo)  |> 
    # add button to control map tiles
    addLayersControl(baseGroups = c("Map","Imagery","Topo", "NatGeo"),
                     options = layersControlOptions(collapsed=T)) %>%
    # add site markers 
    addAwesomeMarkers(data = samp_locs, ~Longitude, ~Latitude, 
                      icon = ~IconSet[Org_Code], #style markers based on site type
                      # label on mouseover
                      label=as.character(samp_locs$Location_ID),
                      labelOptions = labelOptions(noHide = T, textsize = "12px", textOnly = T, 
                                                  direction = 'right', offset = c(10,-5),
                                                  style = list("color" = "black", "font-weight" = "bold")),# offset = c(-10,-5)),
                      # popup on click
                      popup = paste0("<b>Site: ", samp_locs$Location_ID, "</b><br>",
                                     "<b>Org_Code: </b>", samp_locs$Org_Code, "<br>")) |> 
    # add legend
    addControl(markerLegendHTML(IconSet = IconSet), position = "bottomleft") |> 
    addResetMapButton()


```
</div><br>
<br>
```{r chnk4, echo = F, warning = F, message = F}
leaf
```


#### Code Prep
<h4> Install waterGLKN R package </h4>
The waterGLKN package is still a WIP, but at least makes it easier to import and query of GLKN water data using the format of the latest rivers and inland lakes data packages. Must also have RTools44 installed, which can be installed via the Software Center, and the devtools R package. 
```{r chnk5, echo = T, eval = F}
devtools::install_github("katemmiller/waterGLKN")
library(waterGLKN)
```

```{r chnk6, include = F}
library(waterGLKN)
```

<h4> Troubleshooting github-installed packages:</h4>
If you’re unable to install the R package via GitHub (often an error about permission being denied, download the following script and open it in R: <a href="https://doimspp-my.sharepoint.com/:u:/g/personal/kmmiller_nps_gov/ETaknusoEfVOs9tbIbx6QYEBre0WI-_xxi-C0M3JCX_xfw?e=3XAXiC">fix_TLS_inspection.R</a>

Once open in R Studio. Press Control + A to select all of the code. Then Control + Enter to run all of the code. Assuming you don’t return any errors, you should now be able to install from GitHub. Repeat the install_github code above, which hopefully will successful install waterGLKN package.  

<h4> Load other dependencies and imports</h4>
The params csv was developed by GLKN staff manually matching parameter names between GLKN and METC datasets. The csv is posted on the GitHub repo. Note that the waterGLKN package already adds a column of parameter abbreviations following the same naming convention as the params.csv below.
```{r chnk7, results = 'hide', warning = F, message = FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(DT)
library(wqtrends)
library(gridExtra)
library(grid)
params <- read.csv("https://raw.githubusercontent.com/KateMMiller/GLKN_MCES_analysis/refs/heads/main/data/GLKN_vs_METC_params_list_final.csv")
```

#### Compile Data
<h4> Download Data Package and import into R</h4>
Download the latest <a href="https://irma.nps.gov/DataStore/Reference/Profile/2309369"> GLKN Rivers Data Package</a>. The easiest way to do it is to download all as a zip. The file path below is where that zip is stored on Kate's machine and the name of the zip file. Then import the data package into R using the waterGLKN function `importData()`.
```{r chnk8, results = 'hide'}
library(waterGLKN)
river_zip = "../data/GLKN_water/records-2309369.zip"
importData(type = 'zip', filepath = river_zip)
```


<h4> Filter Results.csv by Lake St. Croix sites and prepare data for binding with METC data. </h4>
```{r chnk9, results = 'hide'}
# Site list
lksc <- c("SACN_STCR_20.0", "SACN_STCR_15.8", "SACN_STCR_2.0")
# pull in all results for Lk St. Croix sites
sacn <- getResults(park = "SACN", site = lksc, 
                   sample_type = "VS", #drops QAQC samples
                   parameter = 'all',
                   months = 1:12,
                   sample_depth = 'all',
                   include_censored = T,
                   output = 'verbose') |>
  select(Org_Code, Park_Code, Location_ID, Location_Name, Activity_Type, Activity_Comment, sample_date, doy, year, month,
         depth_cat = Activity_Relative_Depth, depth = Activity_Depth, depth_unit = Activity_Depth_Unit,
         PARAMETER = Characteristic_Name, param_name, value, unit = Result_Unit, Filtered_Fraction, Result_Comment, 
         censored, Result_Detection_Condition, Method_Detection_Limit, Lower_Quantification_Limit, Upper_Quantification_Limit)

# Use Result_Comment to extract censored value
sacn$value_cen <- suppressWarnings(
  ifelse(sacn$Result_Detection_Condition %in% c("Present Above Quantification Limit", "Present Below Quantification Limit"),
           as.numeric(str_extract(sacn$Result_Comment, "\\d*\\.*\\d+")), sacn$value))

sacn$param_name[sacn$param_name == "ChlA_ppb"] <- "ChlA_ugL"
sacn$unit[sacn$param_name == "ChlA_ppb"] <- "ug/l"

# convert depth in ft to m (they're actually all NULL, but in case other sites are in ft for later analysis)
sacn$depth[!is.na(sacn$depth) & sacn$depth_unit == "ft"] <- 
  sacn$depth[!is.na(sacn$depth) & sacn$depth_unit == "ft"] * 0.3048
sacn$depth_unit[sacn$depth_unit == "ft"] <- "m"

# Check for duplicates in sacn
sacn_dups <- sacn |> group_by(Location_ID, sample_date, depth, Activity_Type, param_name) |> 
  mutate(num_samps = sum(!is.na(value))) |> filter(num_samps > 1) |> 
  arrange(Location_ID, sample_date, depth, param_name) |> 
    select(Location_ID, sample_date, depth_cat, depth, Activity_Type, PARAMETER, param_name, value, 
           unit, num_samps, Filtered_Fraction, Activity_Comment, Result_Comment, Result_Detection_Condition)

```

<h4>Duplicates in the SACN data </h4>
In general values are very close. Sometimes one is total and the other dissolved. Other times the dups are the same category. Going to take only the first per group, after sorting by Activity_Comment. 
<div class = "toggle"><button>Show Code</button>
```{r chnk10}
sdk <- kable(sacn_dups, format = 'html', align = c(rep('c', 4), 'l', 'l', 'l', 'c', 'c', 'l', 'l', 'l'), 
             caption = "Duplicate measurements within the same site, date, depth, and parameter. ") |> 
       kable_styling(fixed_thead = TRUE, bootstrap_options = c('condensed'), 
                     full_width = TRUE, position = 'left', font_size = 12) |> 
       collapse_rows(1:7, valign = 'top')
```

</div><br>

```{r chnk11, echo = F}
sdk
```

Missing depths in GLKN SACN data. Only a subset of parameters are regularly sampled as a depth profile. These include <b>DO_mgL</b>, <b>DOsat_pct</b>, <b>pH</b>, <b>SpecCond_uScm</b>, and <b>TempWater_C</b>. 

<div class = "toggle"><button>Show Code</button>
```{r chnk12}
# Check for NAs in depth category. Is it safe to assume these are surface measurements?
miss_depth <- data.frame(table(sacn$depth_cat, complete.cases(sacn$depth))) |> arrange(Var1, Var2) |> 
  pivot_wider(names_from = Var2, values_from = Freq) 
colnames(miss_depth) <- c("Depth_Category", "Num_Missing", "Num_Complete")

kbl_miss_dc <- 
kable(miss_depth, format = 'html', align = c('l', 'c', 'c'), 
      col.names = c("Depth Category", "Records missing", "Records complete"),
             caption = "Missing sample depths by depth category") |> 
       kable_styling(fixed_thead = TRUE, bootstrap_options = c('condensed'), 
                     full_width = TRUE, position = 'left', font_size = 12) 

miss_depth_param <- data.frame(table(sacn$param_name, complete.cases(sacn$depth))) |> arrange(Var1, Var2) |> 
  pivot_wider(names_from = Var2, values_from = Freq)
colnames(miss_depth_param) <- c("Parameter", "Num_Missing", "Num_Complete")

kbl_miss_dcp <- 
kable(miss_depth_param, format = 'html', align = c('l', 'c', 'c'), 
      col.names = c("Parameter", "Records missing", "Records complete"),
             caption = "Missing sample depths (not categories) by parameter") |> 
       kable_styling(fixed_thead = TRUE, bootstrap_options = c('condensed'), 
                     full_width = TRUE, position = 'left', font_size = 12) 

```
</div><br>

```{r chnk13, echo = F}
kbl_miss_dc
```


```{r chnk14, echo = F}
kbl_miss_dcp
```

Final dataset for GLKN SACN to bind with METC
```{r chnk15}
sacn_final <- sacn |> 
  arrange(Activity_Comment) |>
  group_by(Org_Code, Park_Code, Location_ID, Location_Name, Activity_Type,
           sample_date, doy, year, month, depth_cat, depth, depth_unit,
           PARAMETER, param_name, unit, qualifier = Result_Detection_Condition, 
           censored, value_cen) |> 
  summarize(value = first(value), .groups = 'drop')

```

<h4>SACN Non-detect Conditions</h4>
```{r chnk16}
sacn_qual <- sacn_final |> group_by(Location_ID, year, month, param_name, qualifier) |> 
  summarize(num_samps = sum(!is.na(value)), .groups = 'drop') |> 
  filter(qualifier != "Detected and Quantified")

sacn_dt <- datatable(
                sacn_qual, 
                class = 'cell-border stripe', rownames = F, width = '1200px',
                extensions = c("Buttons"),
                options = list(       
                            initComplete = htmlwidgets::JS(
                            "function(settings, json) {",
                              "$('body').css({'font-size': '11px'});",
                              "$('body').css({'font-family': 'Arial'});",
                              "$(this.api().table().header()).css({'font-size': '11px'});",
                              "$(this.api().table().header()).css({'font-family': 'Arial'});",
                            "}"),
                pageLength = 50, autoWidth = TRUE, scrollX = TRUE, scrollY = '600px',
                scrollCollapse = TRUE, lengthMenu = c(5, 10, 50, nrow(sacn_qual)),
                fixedColumns = list(leftColumns = 1),
                dom = "Blfrtip", buttons = c('copy', 'csv', 'print')),
                filter = list(position = 'top', clear = FALSE)#,
                )
```

```{r chnk17}
sacn_dt
```


<h4> Prepare METC data for binding with GLKN data</h4>
Download all data from 2006 and later from the METC's <a href="https://eims.metc.state.mn.us/AdvancedSearch">Environmental Information Management Systems (EIMS)</a> web server for all monitoring locations within Lake St. Croix. The data for this analysis were downloaded on 3/18/2025.
```{r chnk18, results = 'hide'}
# metc data from webserver
metc <- read.csv("./data/local/2025-03-18_1359_56_MCES_EIMS_data.csv")

# name sites based on Rick's stream distance method
metc1 <- metc |> 
  mutate(Location_ID = case_when(grepl("SC0003", STATION_ID) ~ as.character("METC_STCR_0.3"),
                                 grepl("SC0233", STATION_ID) ~ as.character("METC_STCR_23.3"),
                                 grepl("SC0234", STATION_ID) ~ as.character("METC_STCR_23.3"),
                                 grepl("82000100-08", STATION_ID) ~ as.character("METC_STCR_22.5"),
                                 grepl("82000100-06", STATION_ID) ~ as.character("METC_STCR_11.3"),
                                 grepl("82000100-03", STATION_ID) ~ as.character("METC_STCR_16.6"),
                                 grepl("82000100-05", STATION_ID) ~ as.character("METC_STCR_12.4"),
                                 grepl("82000100-04", STATION_ID) ~ as.character("METC_STCR_15.3"),
                                 grepl("82000100-01", STATION_ID) ~ as.character("METC_STCR_22.3"))) |>
  filter(!is.na(Location_ID)) # UM8128 is the only station that doesn't get matched with Rick's new LocIDs

metc1$Org_Code <- "METC"
metc1$Park_Code <- "METC"
metc1$sample_date <- format(as.Date(metc1$START_DATE_TIME, format = "%m/%d/%Y %H:%M"), format = "%Y-%m-%d")
metc1$year <- as.numeric(substr(metc1$sample_date, 1, 4))
metc1$month <- as.numeric(substr(metc1$sample_date, 6, 7))
metc1$doy <- as.numeric(format(as.Date(metc1$sample_date, format = "%Y-%m-%d"), "%j"))
metc1$depth_unit = "m"
metc1$depth_cat <- ifelse(metc1$SAMPLE_DEPTH_m <= 1, "surface", NA_character_)
metc1$censored <- FALSE
metc1$value_cen <- metc1$RESULT

metc2 <- metc1 |>
  mutate(value = ifelse(PARAMETER %in% c( "Chlorophyll-a, Pheo-Corrected",
                                           "Total Nitrate/Nitrite N, Unfiltered",
                                           "Total Phosphorus, Unfiltered",
                                           "Ammonia Nitrogen, Filtered"),
                                           RESULT*1000,
                                           RESULT),
         UNITS = ifelse(PARAMETER %in% c( "Chlorophyll-a, Pheo-Corrected",
                                           "Total Nitrate/Nitrite N, Unfiltered",
                                           "Total Phosphorus, Unfiltered",
                                           "Ammonia Nitrogen, Filtered"),
                                           "ug/L",
                                           UNITS)) |>
  select(Org_Code, Park_Code, Location_ID, Location_Name = NAME, sample_date, doy, year, month,
         depth_cat, depth = SAMPLE_DEPTH_m, depth_unit, PARAMETER, value, units = UNITS, 
         qualifier = QUALIFIER, censored, value_cen)

# Join METC data with param.csv for parameter abbreviations (param_name)
metc_join <- left_join(metc2, params, by = c("PARAMETER" = "Parameter", "units" = "Units")) |>
  filter(!is.na(New_Name)) |>
  mutate(Activity_Type = "Sample") |> 
  select(Org_Code, Park_Code, Location_ID, Location_Name, Activity_Type, sample_date,
         doy, year, month, depth_cat, depth,
         depth_unit, PARAMETER, param_name = New_Name, value, unit = units, qualifier, censored, value_cen)


# Check for duplicate samples in the same site, date, depth, parameter
metc_dup <- metc_join |> group_by(Location_ID, sample_date, depth_cat, depth, param_name, qualifier) |> 
  mutate(num_samps = sum(!is.na(value))) |> filter(num_samps > 1) |> 
  arrange(Location_ID, sample_date, depth, param_name)

```

<h4>METC Data Qualifiers</h4>
```{r chnk19}
metc_qual <- metc_join |> group_by(Location_ID, year, month, param_name, qualifier) |> 
  summarize(num_samps = sum(!is.na(value)), .groups = 'drop') |> filter(qualifier != "Valid")

qual_dt <- datatable(
                metc_qual, 
                class = 'cell-border stripe', rownames = F, width = '1200px',
                extensions = c("Buttons"),
                options = list(       
                            initComplete = htmlwidgets::JS(
                            "function(settings, json) {",
                              "$('body').css({'font-size': '11px'});",
                              "$('body').css({'font-family': 'Arial'});",
                              "$(this.api().table().header()).css({'font-size': '11px'});",
                              "$(this.api().table().header()).css({'font-family': 'Arial'});",
                            "}"),
                pageLength = 50, autoWidth = TRUE, scrollX = TRUE, scrollY = '600px',
                scrollCollapse = TRUE, lengthMenu = c(5, 10, 50, nrow(metc_qual)),
                fixedColumns = list(leftColumns = 1),
                dom = "Blfrtip", buttons = c('copy', 'csv', 'print')),
                filter = list(position = 'top', clear = FALSE)#,
                )
```

<h4>METC data qualifiers that are not "Valid" by site, parameter, and year </h4>
Seems there are a bunch of preliminary records in early years, kind of like how we treat accepted versus certified in our data? But seems like we should drop suspect. 
```{r chnk20}
qual_dt
```

<h4>Duplicates in the METC data </h4>
In general values are very close. Sometimes one is total and the other dissolved. Other times the dups are the same category. Going to take only the first per group, after sorting by Activity_Comment. 
```{r chnk21}
mdk <- kable(metc_dup, format = 'html', align = c(rep('c', 4), 'l', 'l', 'l', 'c', 'c', 'l', 'l', 'l', rep('c', 6)), 
             caption = "Duplicate measurements within the same site, date, depth, and parameter. ") |> 
       kable_styling(fixed_thead = TRUE, bootstrap_options = c('condensed'), 
                     full_width = TRUE, position = 'left', font_size = 12) |> 
       collapse_rows(1:7, valign = 'top')
```

```{r chnk22, echo = F}
mdk
```

```{r}
metc_final <- metc_join |> 
  filter(qualifier != "Suspect") |> 
  group_by(Org_Code, Park_Code, Location_ID, Location_Name, Activity_Type,
           sample_date, doy, year, month, depth_cat, depth, depth_unit,
           PARAMETER, param_name, unit, qualifier, censored, value_cen) |> 
  summarize(value = first(value), .groups = 'drop') 

```


Keep only the parameters in common between GLKN and METC, then use row binding to combine the two datasets together.
```{r chnk23, results = 'hide'}
# Determine parameters from METC that are on the params.csv and drop those missing.
metc_keep <- metc_final |> group_by(param_name) |> summarize(num_samps = sum(!is.na(value))) |> 
  select(param_name) |> unique() |> c()

# SACN- only keep METC params
sacn2 <- sacn_final |> filter(param_name %in% metc_keep$param_name)
#table(sacn$param_name, sacn$Location_ID)
full_dat1 <- rbind(sacn2, metc_final) |> filter(year > 2006 & year < 2025) # GLKN sites only have data from 2007 - 2024
```

<h4>Compile USGS discharge data</h4>
```{r chnk24, cache = T}
dischg <- renameNWISColumns(readNWISdv(siteNumbers = gages, parameterCd = "00060"))
gages <- c("05341550", "05344490")
dischg$Location_ID[dischg$site_no == gages[1]] <- "USGS_STCR_23.35"
dischg$Location_ID[dischg$site_no == gages[2]] <- "USGS_STCR_0.3"
dischg$month <- as.numeric(format(dischg$Date, "%m"))

dis_wide <- dischg |> select(-site_no) |>
  filter(month %in% 4:11) |> # filter only GLKN-sampled months
  pivot_wider(names_from = Location_ID, values_from = c(Flow, Flow_cd)) 

dis_wide_overlap <- dis_wide |> filter(!is.na(Flow_USGS_STCR_0.3) & !is.na(Flow_USGS_STCR_23.35))

dischg2 <- dischg |> filter(Date > as.Date("2011-09-09", format = "%Y-%m-%d"))

dp <- 
ggplot(dischg2, aes(x = Date, y = Flow, group = Location_ID, color = Location_ID)) + 
  geom_line() + theme_WQ() + labs(color = NULL) +
  scale_color_brewer(palette = "Set1")

d_lm <- 
ggplot(dis_wide_overlap, aes(x = Flow_USGS_STCR_23.35, y = Flow_USGS_STCR_0.3)) + 
  geom_point(color = 'grey', alpha = 0.4) +
  geom_smooth(method = 'lm') + theme_WQ() + geom_abline(slope = 1, intercept = 0)

```

Plot of discharge for overlapping sample periods of the stream gages.
```{r chnk25, echo = F}
dp
```

Check of how well gage at 23.5 could predict discharge at 0.2. Error increases a bit for larger flows, but there's not a ton of data in the higher ranges and increase in variance is not terrible. The SACN_STCR_15.8 site is between the two gages, and I'm wondering if I can interpolate discharge for that site based on the other two gages. 
```{r chnk26, echo = F}
d_lm
```


Check on flow rating. Most are A, a few P (provisional). The 'e' refers to estimated. 
```{r chnk27}
table(dischg$Location_ID, dischg$Flow_cd)
```

Correlation in discharge between the two sites
```{r chnk28}
round(cor(dis_wide_overlap[,c("Flow_USGS_STCR_23.35", "Flow_USGS_STCR_0.3")]), 2)[1,2] # 0.96
```

```{r chnk29}
mod <- lm(Flow_USGS_STCR_0.3 ~ Flow_USGS_STCR_23.35, data = dis_wide_overlap)
summary(mod)
```


### Sampling Intensity {.tabset}
#### Code
```{r chnk30}
#full_dat2 <- full_dat1 |> filter(!Location_ID %in% "METC_STCR_23.3") # 23.3 has a very narrow period of record. Dropping

full_dat1$site_abbr <- factor(gsub("_STCR", "", full_dat1$Location_ID),
                              levels = c("METC_23.3", #"METC_23.3", 
                                         "METC_22.5", "METC_22.3",
                                         "SACN_20.0", "METC_16.6", "SACN_15.8", "METC_15.3",
                                         "METC_12.4", "METC_11.3", "SACN_2.0", "METC_0.3"))

full_dat1$site_order <- factor(full_dat1$Location_ID, 
                               levels = c("METC_STCR_23.3", #"METC_STCR_23.3", 
                                          "METC_STCR_22.5", "METC_STCR_22.3",
                                          "SACN_STCR_20.0", "METC_STCR_16.6", "SACN_STCR_15.8", "METC_STCR_15.3",
                                          "METC_STCR_12.4",  "METC_STCR_11.3", "SACN_STCR_2.0", "METC_STCR_0.3"))
full_dat1$sample_date <- as.Date(full_dat1$sample_date, format = "%Y-%m-%d")

# Add discharge as columns, so they can be modeled as covariates
full_dat2 <- left_join(full_dat1, 
                      dis_wide |> select(Date, Flow_USGS_STCR_0.3, Flow_USGS_STCR_23.35, 
                                         Flow_cd_USGS_STCR_0.3, Flow_cd_USGS_STCR_23.35), 
                      by = c("sample_date" = "Date"))

# Add water temperature as a column, so it can be modeled as a covariate. Because there are occasionally
# duplicate water temps in the METC data, but they're always within a few tenths of a degree, taking 
# the average of the two measurements. 
wtemp <- full_dat2 |> filter(param_name == "TempWater_C") |> 
  select(Location_ID, sample_date, depth_cat, depth, WaterTemp_C = value) |> 
  filter(!is.na(WaterTemp_C)) |> 
  group_by(Location_ID, sample_date, depth_cat, depth) |> 
  summarize(WaterTemp_C = mean(WaterTemp_C), .groups = 'drop')

```

```{r chnk31}
full_dat <- left_join(full_dat2, wtemp, by = c("Location_ID", "sample_date", "depth", "depth_cat")) 

param_site_year_qual <- full_dat |> 
  group_by(Site = site_abbr, Parameter = param_name, Year = year, Org_Code, qualifier) |> 
  summarize(Num_Samps = sum(!is.na(param_name)), .groups = 'drop') |> 
  arrange(Site, Parameter, Year, qualifier)

# params_site_year <- full_dat |> group_by(Site = site_abbr, Parameter = param_name, Year = year, Org_Code) |> 
#   summarize(Num_Samps = sum(!is.na(value)),
#             .groups = 'drop') |> 
#   arrange(Site, Parameter, Year)

params_site_year_wide <- param_site_year_qual |> #filter(Num_Samps > 0) |> 
  pivot_wider(names_from = Site, values_from = Num_Samps) |> 
  arrange(Parameter, Year)

cols <- names(params_site_year_wide[,6:ncol(params_site_year_wide)])
params_site_year_wide[,cols][params_site_year_wide[,cols] == 0] <- NA_real_

dischg$month <- as.numeric(format(dischg$Date, "%m"))
dischg$year <- as.numeric(format(dischg$Date, "%Y"))

dis_yrm <- dischg |> 
  #filter(month %in% 4:11) |> 
  group_by(Location_ID, month, year) |> 
  summarize(Num_Dis = sum(!is.na(Flow)),
            .groups = 'drop') 

dis_yr <- dischg |> 
  #filter(month %in% 4:11) |> 
  group_by(Location_ID, year) |> 
  summarize(Num_Dis = sum(!is.na(Flow)),
            .groups = 'drop') 

# sampling matrix 
psy_tab <- kable(params_site_year_wide, format = 'html', align = 'c', 
  cap = "Sampling matrix by site for every parameter and year. Values are number of non-QAQC samples within a year. Site codes start with 'METC' for Metropolitan Councial sites, and 'SACN' for GLKN-monitored sites. Numbers indicate the stream miles.") |> 
  kable_styling(fixed_thead = T, bootstrap_options = c("condensed"), full_width = F) |> 
  column_spec(1:ncol(params_site_year_wide), border_left = T, border_right = T) |> 
  collapse_rows(1, valign = 'top') 

params_site_year1 <- param_site_year_qual |> 
  mutate(num_samps_bin = case_when(between(Num_Samps, 1, 5) ~ 1,
                                   between(Num_Samps, 6, 10) ~ 2,
                                   between(Num_Samps, 11, 15) ~ 3,
                                   between(Num_Samps, 16, 20) ~ 4,
                                   Num_Samps > 20 ~ 5),
         qual_simp = case_when(qualifier %in% c("Valid", "Preliminary") ~ "Detected and Quantified",
                               qualifier == "Suspect" ~ "Not Reported",
                               TRUE ~ qualifier)) |> 
 filter(Num_Samps > 0)

# Create heat map of overall sampling intensity
psy_plot <- 
  ggplot(params_site_year1, aes(x = Site, y = Year)) +
    geom_tile(aes(fill = num_samps_bin), color = 'grey') + facet_wrap(~Parameter, ncol = 3) +
    scale_fill_distiller(palette = "Spectral", guide = "legend", name = "Num. Sample Bins", 
                         labels = c("Bin 1-5", "Bin 6-10", "Bin 11-15", "Bin 16-20", "Bin > 20")) +
    theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)) +
    waterGLKN::theme_WQ() +
    labs(x = NULL) +
    scale_y_continuous(breaks = c(2006, 2010, 2014, 2018, 2022))
# 
# Plotting function to iterate through each parameter detects
param_detect_heatmap <- function(dat = params_site_year1, param = NA){
  p <-
    ggplot(dat, aes(x = Site, y = Year)) +
    geom_tile(aes(fill = Num_Samps), color = 'grey') +
    facet_wrap(~qual_simp)+
    scale_fill_distiller(palette = "Spectral", guide = 'legend', 
                         name = "# samples") +
    theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)) +
    labs(x = NULL, y = NULL) +
    theme_bw()

    return(p)
}

dis_ym_plot <- 
  ggplot(dis_yrm, aes(x = Location_ID, y = month)) +
  geom_tile(aes(fill = Num_Dis), color = 'grey') + 
  facet_grid(rows = vars(year)) +
  scale_fill_distiller(palette = "Spectral", guide = 'legend', 
                       name = "# samples") +
  theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)) +
  labs(x = NULL, y = NULL) +
  scale_y_continuous(breaks = seq(1, 12, 2), labels = c("Jan", "Mar", "May", "Jul", "Sep", "Nov"))

params_site_year_month <- full_dat |> group_by(Site = site_abbr, param_name, year, month) |> 
  summarize(num_samps = sum(!is.na(value)), .groups = 'drop') |> filter(num_samps > 0)

# Plotting function to iterate through each parameter
# param_heatmap <- function(dat = param_site_year_month, param = NA){
#   p <-
#     ggplot(dat, aes(x = Site, y = month)) +
#     geom_tile(aes(fill = num_samps), color = 'grey') +
#     facet_grid(rows = vars(year), cols = vars(qual_simp))+
#     scale_fill_distiller(palette = "Spectral", guide = 'legend', 
#                          name = "# samples") +
#     theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)) +
#     labs(x = NULL, y = NULL) +
#     scale_y_reverse(breaks = seq(1, 12, 2), labels = c("Jan", "Mar", "May", "Jul", "Sep", "Nov"))
# 
#     return(p)
# }

param_detect_heatmap <- function(dat = params_site_year1, param = NA){
  p <-
    ggplot(dat, aes(x = Site, y = Year)) +
    geom_tile(aes(fill = factor(num_samps_bin)), color = 'grey') +
    facet_wrap(~factor(qual_simp), ncol = 4) +
    scale_fill_manual(guide = 'legend', 
                      values = c("#067bc2", "#80e377", "#ecc30b", "#f37748", "#d56062"),
                      name = "Binned # of samples",
                      breaks = 1:5,
                      labels = c("1-5", "6-10", "11-15", "16-20", ">20"), 
                      drop = F) +
    theme_bw() +
    labs(x = NULL, y = NULL) +
    scale_y_continuous(breaks = seq(2006, 2024, 2)) +
    theme(axis.text.x = element_text(angle = 90, hjust = 0, vjust = 0.5)) 

    return(p)
}
param_list <- sort(unique(full_dat$param_name))
```

```{r sym_heatmap_chunk, warning = F, message = F, eval = FALSE, echo = F, fig.height = 10, fig.width = 8}
p <- param_detect_heatmap(dat = df, param = prm)
print(p)
```

#### Sampling Matrix

```{r chnk32, echo = F}
psy_tab
```

#### Sampling Heat Maps {.tabset}
##### All Params
Main takeaways from sampling intensity: 
<ul>
<li>METC_STCR_23.3 and METC_STCR_0.3 collect the most data, and at a greater frequency within years than GLKN sites.</li>
<li>METC_STCR_22.5, METC_STCR_22.3, METC_STCR_16.6, METC_STCR_15.3, METC_STCR_12.4, METC_STCR_11.3 primarily only have water temperature, Secchi depth, and ChlA associated with them.</li>

<li>Parameters and sites to model for redundancy analyses </li>
  <ul>
  <li><b>ChlA_ugL</b>: Good overlap among all sites and years. Analyze for all sites. </li>
  <li><b>Cl_mgL</b>: Analyze for METC_23.3 and METC_0.3 (~continuous record); periodic samples with only occasionally censored data in GLKN sites. </li>
  <li><b>DO_mgL</b>: Analyze for METC_23.3 and METC_0.3 (~continuous record); good coverage in GLKN sites with only occasionally censored data in GLKN sites. </li>
  <li><b>NO2+NO3_ugL</b>: Analyze for METC_23.3 and METC_0.3 starting in 2018.</li>
  <li><b>P_ugL</b>: Analyze for METC_23.3 and METC_0.3 (~continuous record); periodic samples in GLKN sites .</li>
  <li><b>pH</b>: Analyze for METC_23.3 and METC_0.3 (~continuous record); good coverage in GLKN sites with some missing data in 2020. </li>
  <li><b>Secchi_m</b>: Good overlap among all sites and years. Occasionally missing for GLKN sites. Analyze for all sites. </li>
  <li><b>SO4_mgL</b>: Analyze for METC_23.3 and METC_0.3 (biweekly until 2019); periodic samples in GLKN sites.</li>
  <li><b>SpecCond_uScm</b>: Analyze for METC_23.3 and METC_0.3 (~continuous record); good coverage in GLKN sites. </li>
  <li><b>TempWater_C</b>:  Good overlap among all METC sites and years. Analyze for all sites. SACN_15.8 is the only GLKN site with data past 2010.</li>
  <li><b>TSS_mgL</b>: Analyze for METC_23.3 and METC_0.3 (~continuous record); periodic samples in GLKN sites, with occasional censored or non-detects.</li>
  </ul>
  
<li>Parameters that may be included after first cut: </li>
<ul>
  <li><b>Alkalinity_mgL</b>: METC started collecting in METC_23.3 and METC_0.3 in 2017, but GLKN has record back to 2007. </li>
  <li><b>DOC_mgL</b>: METC started collecting in METC_23.3 and METC_0.3 in 2016, but GLKN has record back to 2007.  </li>

</ul>
  
<li>Parameters dropped from redundancy analysis with notes: </li>
  <ul>
  <li><b>Ca_mgL</b>: No new samples since 2020 in METC.</li>
  <li><b>DOsat_pct</b>: Not sampled by METC. Will use DO_mgL. </li>
  <li><b>K_mgL</b>: No new samples since 2020 in METC.</li>
  <li><b>Mg_mgL</b>: No new samples since 2020 in METC.</li>
  <li><b>Na_mgL</b>: No new samples since 2020 in METC.</li>
  <li><b>NH4_ugL</b>: No new samples since 2014 in METC, and fair amount of censored samples in GLKN.</li>
  <li><b>Si_mgL</b>: No new samples since 2021 in METC. </li>
  <li><b>Transp_cm</b>: No new samples since 2016 in METC, and lots of censored data in GLKN sites. </li>
  </ul>
</ul>

```{r chnk33, echo = F, out.width = "100%", fig.height = 10, fig.cap="Heatmap of sampling intensity by site, parameter and year, such that blue bins were sampled 1-5 times within a given year and site, red bins more than 20 samples within a given year, etc. Sites or ordered by stream mile. Sites with METC are monitored by the MetCouncil. Sites with SACN are monitored by GLKN."}
psy_plot
```

<div class = "toggle"><button>Show Code</button>
```{r results = 'asis', fig.height = 10, fig.width = 8, echo = F}
for(i in seq_along(param_list)){
  prm <- param_list[[i]]
  df <- params_site_year1 |> filter(Parameter %in% prm)
  cat("##### ", prm, "\n\n")
  cat(paste0("Heat map of number of samples collected in each year by site for <b>", prm, " and detection status</b>."))
  <<sym_heatmap_chunk>>
  cat("\n\n")
  cat("\n\n")
}

```
</div><br>

##### Discharge
```{r chnk55,  echo = F, fig.height = 10}
dis_ym_plot
```

#### Final Dataset {.tabset}

<div class = "toggle"><button>Show Code</button>
```{r chnk56}
final_dat <- full_dat |> filter(month %in% 4:11)

dt <- datatable(final_dat, 
                class = 'cell-border stripe', rownames = F, width = '1200px',
                extensions = c("Buttons"),
                options = list(       
                            initComplete = htmlwidgets::JS(
                            "function(settings, json) {",
                              "$('body').css({'font-size': '11px'});",
                              "$('body').css({'font-family': 'Arial'});",
                              "$(this.api().table().header()).css({'font-size': '11px'});",
                              "$(this.api().table().header()).css({'font-family': 'Arial'});",
                            "}"),
                pageLength = 50, autoWidth = TRUE, scrollX = TRUE, scrollY = '600px',
                scrollCollapse = TRUE, lengthMenu = c(5, 10, 50, nrow(full_dat)),
                fixedColumns = list(leftColumns = 1),
                dom = "Blfrtip", buttons = c('copy', 'csv', 'print')),
                filter = list(position = 'top', clear = FALSE)#,
                )

```
</div><br>

```{r, chnk57, echo = F}
dt
```


```{r chnk58, eval = F, echo = F, include = F}
write.csv(full_dat, "./data/local/GLKN_METC_combined_data.csv", row.names = F)
```

### Exploratory Analysis {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk59, echo = F, include = F}
all_sites <- sort(unique(full_dat$site_order))
core_sites <- c("METC_STCR_23.3", "SACN_STCR_20.0", "SACN_STCR_15.8", "SACN_STCR_2.0", "METC_STCR_0.3")

core_params <-  c("Alkalinity_mgL", "ChlA_ugL", "Cl_mgL", "DOC_mgL", "DO_mgL", "NO2+NO3_ugL",
                  "P_ugL", "pH", "Secchi_m", "SO4_mgL", "SpecCond_uScm", "TempWater_C", "TSS_mgL")   
```
</div><br>

#### Loess smoothed trends core sites {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk60, echo = F}
dat <- read.csv("./data/local/GLKN_METC_combined_data.csv")
dat$year_cen <- dat$year - min(dat$year)
dat$date <- as.Date(dat$sample_date, format = "%Y-%m-%d")
dat$site <- factor(gsub("_STCR", "", dat$Location_ID),
                   levels = c("METC_23.3", #"METC_23.3",
                              "METC_22.5", "METC_22.3",
                              "SACN_20.0", "METC_16.6", "SACN_15.8", "METC_15.3",
                              "METC_12.4", "METC_11.3", "SACN_2.0", "METC_0.3"))

core_sites_abbr <- c("METC_23.3", "SACN_20.0", "SACN_15.8", "SACN_2.0", "METC_0.3")

#---- From JP----
format_data <- function(dat){dat |>
    mutate(ylength = ifelse(leap_year(year), 366, 365),
           wcos = cos(2*pi*doy/ylength),
           wsin = sin(2*pi*doy/ylength),
           numday = as.numeric(date)/1000,
           cont_year = year+(doy/ylength), # same as cont_year in wqtrends package
           nonzero = ifelse(value > 0, 1, 0))}

dat2 <- format_data(dat) |> filter(month %in% c(4:11)) |> filter(depth_cat %in% c("surface", "Surface") | is.na(depth_cat))

all_sites <- sort(unique(dat2$site))
#params_plot <- sort(unique(param_site_mat$param_name))
params_plot <- sort(unique(dat2$param_name))

plot_water_series <- function(df = dat2, param, sites = core_sites_abbr){
  p <-
    ggplot(df |> filter(param_name %in% param) |> filter(site %in% sites) |> 
             filter(depth_cat %in% c("Surface", "surface") | is.na(depth_cat)) |> droplevels(),
           aes(x = cont_year, y = value, group = site, color = site)) +
    geom_point(aes(shape = site), alpha = 0.3, size = 2) +
    geom_smooth(se = F) +
    scale_color_brewer(guide = "legend", palette = "Set1") +
    scale_shape_manual(values = c(16, 19, 19, 19, 16)) +
    facet_wrap(~site, nrow = 1) +
    theme_WQ() +
    labs(y = param, x = NULL, color = "Site", shape = "Site")
  p
}

```
</div><br>

```{r water_series_chunk, warning = F, message = F, eval = FALSE, echo = F, fig.height = 8, fig.width = 10}
p <- plot_water_series(df = dat2, param = prm)
print(p)
```


```{r results = 'asis', fig.height = 8, fig.width = 10, echo = F}
for(i in seq_along(core_params)){
  prm <- core_params[[i]]
  cat("##### ", prm, "\n\n")
  cat(paste0("Loess smoothed trends in surface <b>", prm, "</b> for each core monitoring site for April through November monitoring period.", "\n"))
  <<water_series_chunk>>
  cat("\n\n")
  cat("\n\n")
}

```

#### GAMs on core params/sites {.tabset}
```{r chnk84, echo = F}
wqdat <- dat2 |> select(date, station = site, param = param_name, 
                        value, doy, cont_year, yr = year, mo = month) |> 
  filter(!is.na(value))
```

##### ChlA_mgL {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk85, results = 'hide'}
ylabel = "Chlorophyll-a (ug/L)"
chla_metc23.3 <- wqdat |> filter(param == "ChlA_ugL") |> filter(station == "METC_23.3")
chla_mod23.3 <- anlz_gam(chla_metc23.3)
anlz_smooth(chla_mod23.3)
anlz_fit(chla_mod23.3)
chla_metc23.3_doy <- show_prddoy(chla_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
chla_metc23.3_series <- show_prdseries(chla_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
chla_metc23.3_season <- show_prdseason(chla_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

chla_sacn20.0 <- wqdat |> filter(param == "ChlA_ugL") |> filter(station == "SACN_20.0")
chla_mod20.0 <- anlz_gam(chla_sacn20.0)
anlz_smooth(chla_mod20.0)
anlz_fit(chla_mod20.0)
chla_sacn20.0_doy <- show_prddoy(chla_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
chla_sacn20.0_series <- show_prdseries(chla_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
chla_sacn20.0_season <- show_prdseason(chla_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

chla_sacn15.8 <- wqdat |> filter(param == "ChlA_ugL") |> filter(station == "SACN_15.8")
chla_mod15.8 <- anlz_gam(chla_sacn15.8)
anlz_smooth(chla_mod15.8)
anlz_fit(chla_mod15.8)
chla_sacn15.8_doy <- show_prddoy(chla_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
chla_sacn15.8_series <- show_prdseries(chla_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
chla_sacn15.8_season <- show_prdseason(chla_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

chla_sacn2.0 <- wqdat |> filter(param == "ChlA_ugL") |> filter(station == "SACN_2.0")
chla_mod2.0 <- anlz_gam(chla_sacn2.0)
anlz_smooth(chla_mod2.0)
anlz_fit(chla_mod2.0)
chla_sacn2.0_doy <- show_prddoy(chla_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
chla_sacn2.0_series <- show_prdseries(chla_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
chla_sacn2.0_season <- show_prdseason(chla_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

chla_metc0.3 <- wqdat |> filter(param == "ChlA_ugL") |> filter(station == "METC_0.3")
chla_mod0.3 <- anlz_gam(chla_metc0.3)
anlz_smooth(chla_mod0.3)
anlz_fit(chla_mod0.3)
chla_metc0.3_doy <- show_prddoy(chla_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
chla_metc0.3_series <- show_prdseries(chla_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'none')
chla_metc0.3_season <- show_prdseason(chla_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

chla_doy <- arrangeGrob(chla_metc23.3_doy, chla_sacn20.0_doy, chla_sacn15.8_doy, chla_sacn2.0_doy, chla_metc0.3_doy, ncol = 1)
chla_series <- arrangeGrob(chla_metc23.3_series, chla_sacn20.0_series, chla_sacn15.8_series, chla_sacn2.0_series, chla_metc0.3_series, ncol = 1)
chla_season <- arrangeGrob(chla_metc23.3_season, chla_sacn20.0_season, chla_sacn15.8_season, chla_sacn2.0_season, chla_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk86, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(chla_doy)
```

###### Month by year {.tabset}
```{r chnk87, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(chla_season)
```

###### Full time series {.tabset}
```{r chnk88, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(chla_series)
```


##### Cl_mgL {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk89, results = 'hide'}
ylabel = "Chloride (mg/L)"
cl_metc23.3 <- wqdat |> filter(param == "Cl_mgL") |> filter(station == "METC_23.3")
cl_mod23.3 <- anlz_gam(cl_metc23.3)
anlz_smooth(cl_mod23.3)
anlz_fit(cl_mod23.3)
cl_metc23.3_doy <- show_prddoy(cl_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
cl_metc23.3_series <- show_prdseries(cl_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
cl_metc23.3_season <- show_prdseason(cl_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

cl_sacn20.0 <- wqdat |> filter(param == "Cl_mgL") |> filter(station == "SACN_20.0")
cl_mod20.0 <- anlz_gam(cl_sacn20.0)
anlz_smooth(cl_mod20.0)
anlz_fit(cl_mod20.0)
cl_sacn20.0_doy <- show_prddoy(cl_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
cl_sacn20.0_series <- show_prdseries(cl_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
cl_sacn20.0_season <- show_prdseason(cl_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

cl_sacn15.8 <- wqdat |> filter(param == "Cl_mgL") |> filter(station == "SACN_15.8")
cl_mod15.8 <- anlz_gam(cl_sacn15.8)
anlz_smooth(cl_mod15.8)
anlz_fit(cl_mod15.8)
cl_sacn15.8_doy <- show_prddoy(cl_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
cl_sacn15.8_series <- show_prdseries(cl_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
cl_sacn15.8_season <- show_prdseason(cl_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

cl_sacn2.0 <- wqdat |> filter(param == "Cl_mgL") |> filter(station == "SACN_2.0")
cl_mod2.0 <- anlz_gam(cl_sacn2.0)
anlz_smooth(cl_mod2.0)
anlz_fit(cl_mod2.0)
cl_sacn2.0_doy <- show_prddoy(cl_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
cl_sacn2.0_series <- show_prdseries(cl_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
cl_sacn2.0_season <- show_prdseason(cl_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

cl_metc0.3 <- wqdat |> filter(param == "Cl_mgL") |> filter(station == "METC_0.3")
cl_mod0.3 <- anlz_gam(cl_metc0.3)
anlz_smooth(cl_mod0.3)
anlz_fit(cl_mod0.3)
cl_metc0.3_doy <- show_prddoy(cl_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
cl_metc0.3_series <- show_prdseries(cl_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
cl_metc0.3_season <- show_prdseason(cl_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

cl_doy <- arrangeGrob(cl_metc23.3_doy, cl_sacn20.0_doy, cl_sacn15.8_doy, cl_sacn2.0_doy, cl_metc0.3_doy, ncol = 1)
cl_series <- arrangeGrob(cl_metc23.3_series, cl_sacn20.0_series, cl_sacn15.8_series, cl_sacn2.0_series, cl_metc0.3_series, ncol = 1)
cl_season <- arrangeGrob(cl_metc23.3_season, cl_sacn20.0_season, cl_sacn15.8_season, cl_sacn2.0_season, cl_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk90, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(cl_doy)
```

###### Month by year {.tabset}
```{r chnk91, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(cl_season)
```

###### Full time series {.tabset}
```{r chnk92, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(cl_series)
```


##### DOC_mgL {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk93, results = 'hide'}
ylabel = "Dissolved Organic Carbon (mg/L)"
doc_metc23.3 <- wqdat |> filter(param == "DOC_mgL") |> filter(station == "METC_23.3")
doc_mod23.3 <- anlz_gam(doc_metc23.3)
anlz_smooth(doc_mod23.3)
anlz_fit(doc_mod23.3)
doc_metc23.3_doy <- show_prddoy(doc_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
doc_metc23.3_series <- show_prdseries(doc_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
doc_metc23.3_season <- show_prdseason(doc_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

doc_sacn20.0 <- wqdat |> filter(param == "DOC_mgL") |> filter(station == "SACN_20.0")
doc_mod20.0 <- anlz_gam(doc_sacn20.0)
anlz_smooth(doc_mod20.0)
anlz_fit(doc_mod20.0)
doc_sacn20.0_doy <- show_prddoy(doc_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
doc_sacn20.0_series <- show_prdseries(doc_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
doc_sacn20.0_season <- show_prdseason(doc_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

doc_sacn15.8 <- wqdat |> filter(param == "DOC_mgL") |> filter(station == "SACN_15.8")
doc_mod15.8 <- anlz_gam(doc_sacn15.8)
anlz_smooth(doc_mod15.8)
anlz_fit(doc_mod15.8)
doc_sacn15.8_doy <- show_prddoy(doc_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
doc_sacn15.8_series <- show_prdseries(doc_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
doc_sacn15.8_season <- show_prdseason(doc_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

doc_sacn2.0 <- wqdat |> filter(param == "DOC_mgL") |> filter(station == "SACN_2.0")
doc_mod2.0 <- anlz_gam(doc_sacn2.0)
anlz_smooth(doc_mod2.0)
anlz_fit(doc_mod2.0)
doc_sacn2.0_doy <- show_prddoy(doc_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
doc_sacn2.0_series <- show_prdseries(doc_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
doc_sacn2.0_season <- show_prdseason(doc_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

doc_metc0.3 <- wqdat |> filter(param == "DOC_mgL") |> filter(station == "METC_0.3")
doc_mod0.3 <- anlz_gam(doc_metc0.3)
anlz_smooth(doc_mod0.3)
anlz_fit(doc_mod0.3)
doc_metc0.3_doy <- show_prddoy(doc_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
doc_metc0.3_series <- show_prdseries(doc_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
doc_metc0.3_season <- show_prdseason(doc_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

doc_doy <- arrangeGrob(doc_metc23.3_doy, doc_sacn20.0_doy, doc_sacn15.8_doy, doc_sacn2.0_doy, doc_metc0.3_doy, ncol = 1)
doc_series <- arrangeGrob(doc_metc23.3_series, doc_sacn20.0_series, doc_sacn15.8_series, doc_sacn2.0_series, doc_metc0.3_series, ncol = 1)
doc_season <- arrangeGrob(doc_metc23.3_season, doc_sacn20.0_season, doc_sacn15.8_season, doc_sacn2.0_season, doc_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk94, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(doc_doy)
```

###### Month by year {.tabset}
```{r chnk95, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(doc_season)
```

###### Full time series {.tabset}
```{r chnk96, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(doc_series)
```

##### NO2+NO3_ugL {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk97, results = 'hide'}
ylabel = "NO2 + NO3 (ug/L)"
nox_metc23.3 <- wqdat |> filter(param == "NO2+NO3_ugL") |> filter(station == "METC_23.3")
nox_mod23.3 <- anlz_gam(nox_metc23.3)
anlz_smooth(nox_mod23.3)
anlz_fit(nox_mod23.3)
nox_metc23.3_doy <- show_prddoy(nox_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
nox_metc23.3_series <- show_prdseries(nox_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
nox_metc23.3_season <- show_prdseason(nox_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

nox_sacn20.0 <- wqdat |> filter(param == "NO2+NO3_ugL") |> filter(station == "SACN_20.0")
nox_mod20.0 <- anlz_gam(nox_sacn20.0)
anlz_smooth(nox_mod20.0)
anlz_fit(nox_mod20.0)
nox_sacn20.0_doy <- show_prddoy(nox_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
nox_sacn20.0_series <- show_prdseries(nox_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
nox_sacn20.0_season <- show_prdseason(nox_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

nox_sacn15.8 <- wqdat |> filter(param == "NO2+NO3_ugL") |> filter(station == "SACN_15.8")
nox_mod15.8 <- anlz_gam(nox_sacn15.8)
anlz_smooth(nox_mod15.8)
anlz_fit(nox_mod15.8)
nox_sacn15.8_doy <- show_prddoy(nox_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
nox_sacn15.8_series <- show_prdseries(nox_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
nox_sacn15.8_season <- show_prdseason(nox_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

nox_sacn2.0 <- wqdat |> filter(param == "NO2+NO3_ugL") |> filter(station == "SACN_2.0")
nox_mod2.0 <- anlz_gam(nox_sacn2.0)
anlz_smooth(nox_mod2.0)
anlz_fit(nox_mod2.0)
nox_sacn2.0_doy <- show_prddoy(nox_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
nox_sacn2.0_series <- show_prdseries(nox_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
nox_sacn2.0_season <- show_prdseason(nox_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

nox_metc0.3 <- wqdat |> filter(param == "NO2+NO3_ugL") |> filter(station == "METC_0.3")
nox_mod0.3 <- anlz_gam(nox_metc0.3)
anlz_smooth(nox_mod0.3)
anlz_fit(nox_mod0.3)
nox_metc0.3_doy <- show_prddoy(nox_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
nox_metc0.3_series <- show_prdseries(nox_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
nox_metc0.3_season <- show_prdseason(nox_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

nox_doy <- arrangeGrob(nox_metc23.3_doy, nox_sacn20.0_doy, nox_sacn15.8_doy, nox_sacn2.0_doy, nox_metc0.3_doy, ncol = 1)
nox_series <- arrangeGrob(nox_metc23.3_series, nox_sacn20.0_series, nox_sacn15.8_series, nox_sacn2.0_series, nox_metc0.3_series, ncol = 1)
nox_season <- arrangeGrob(nox_metc23.3_season, nox_sacn20.0_season, nox_sacn15.8_season, nox_sacn2.0_season, nox_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk98, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(nox_doy)
```

###### Month by year {.tabset}
```{r chnk99, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(nox_season)
```
 
###### Full time series {.tabset}
```{r chnk100, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(nox_series)
```

##### P_ugL {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk101, results = 'hide'}
ylabel = "Total Phosphorus (ug/L)"
tp_metc23.3 <- wqdat |> filter(param == "P_ugL") |> filter(station == "METC_23.3")
tp_mod23.3 <- anlz_gam(tp_metc23.3)
anlz_smooth(tp_mod23.3)
anlz_fit(tp_mod23.3)
tp_metc23.3_doy <- show_prddoy(tp_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
tp_metc23.3_series <- show_prdseries(tp_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
tp_metc23.3_season <- show_prdseason(tp_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

tp_sacn20.0 <- wqdat |> filter(param == "P_ugL") |> filter(station == "SACN_20.0")
tp_mod20.0 <- anlz_gam(tp_sacn20.0)
anlz_smooth(tp_mod20.0)
anlz_fit(tp_mod20.0)
tp_sacn20.0_doy <- show_prddoy(tp_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
tp_sacn20.0_series <- show_prdseries(tp_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
tp_sacn20.0_season <- show_prdseason(tp_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

tp_sacn15.8 <- wqdat |> filter(param == "P_ugL") |> filter(station == "SACN_15.8")
tp_mod15.8 <- anlz_gam(tp_sacn15.8)
anlz_smooth(tp_mod15.8)
anlz_fit(tp_mod15.8)
tp_sacn15.8_doy <- show_prddoy(tp_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
tp_sacn15.8_series <- show_prdseries(tp_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
tp_sacn15.8_season <- show_prdseason(tp_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

tp_sacn2.0 <- wqdat |> filter(param == "P_ugL") |> filter(station == "SACN_2.0")
tp_mod2.0 <- anlz_gam(tp_sacn2.0)
anlz_smooth(tp_mod2.0)
anlz_fit(tp_mod2.0)
tp_sacn2.0_doy <- show_prddoy(tp_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
tp_sacn2.0_series <- show_prdseries(tp_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
tp_sacn2.0_season <- show_prdseason(tp_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

tp_metc0.3 <- wqdat |> filter(param == "P_ugL") |> filter(station == "METC_0.3")
tp_mod0.3 <- anlz_gam(tp_metc0.3)
anlz_smooth(tp_mod0.3)
anlz_fit(tp_mod0.3)
tp_metc0.3_doy <- show_prddoy(tp_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
tp_metc0.3_series <- show_prdseries(tp_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
tp_metc0.3_season <- show_prdseason(tp_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

tp_doy <- arrangeGrob(tp_metc23.3_doy, tp_sacn20.0_doy, tp_sacn15.8_doy, tp_sacn2.0_doy, tp_metc0.3_doy, ncol = 1)
tp_series <- arrangeGrob(tp_metc23.3_series, tp_sacn20.0_series, tp_sacn15.8_series, tp_sacn2.0_series, tp_metc0.3_series, ncol = 1)
tp_season <- arrangeGrob(tp_metc23.3_season, tp_sacn20.0_season, tp_sacn15.8_season, tp_sacn2.0_season, tp_metc0.3_season, ncol = 1)
```
</div><br>
 
###### Day of year by year {.tabset}
```{r chnk102, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(tp_doy)
```

###### Month by year {.tabset}
```{r chnk103, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(tp_season)
```

###### Full time series {.tabset}
```{r chnk104, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(tp_series)
```

##### pH {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk105, results = 'hide'}
ylabel = "pH"
pH_metc23.3 <- wqdat |> filter(param == "pH") |> filter(station == "METC_23.3")
pH_mod23.3 <- anlz_gam(pH_metc23.3)
anlz_smooth(pH_mod23.3)
anlz_fit(pH_mod23.3)
pH_metc23.3_doy <- show_prddoy(pH_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
pH_metc23.3_series <- show_prdseries(pH_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
pH_metc23.3_season <- show_prdseason(pH_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

pH_sacn20.0 <- wqdat |> filter(param == "pH") |> filter(station == "SACN_20.0")
pH_mod20.0 <- anlz_gam(pH_sacn20.0)
anlz_smooth(pH_mod20.0)
anlz_fit(pH_mod20.0)
pH_sacn20.0_doy <- show_prddoy(pH_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
pH_sacn20.0_series <- show_prdseries(pH_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
pH_sacn20.0_season <- show_prdseason(pH_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

pH_sacn15.8 <- wqdat |> filter(param == "pH") |> filter(station == "SACN_15.8")
pH_mod15.8 <- anlz_gam(pH_sacn15.8)
anlz_smooth(pH_mod15.8)
anlz_fit(pH_mod15.8)
pH_sacn15.8_doy <- show_prddoy(pH_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
pH_sacn15.8_series <- show_prdseries(pH_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
pH_sacn15.8_season <- show_prdseason(pH_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

pH_sacn2.0 <- wqdat |> filter(param == "pH") |> filter(station == "SACN_2.0")
pH_mod2.0 <- anlz_gam(pH_sacn2.0)
anlz_smooth(pH_mod2.0)
anlz_fit(pH_mod2.0)
pH_sacn2.0_doy <- show_prddoy(pH_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
pH_sacn2.0_series <- show_prdseries(pH_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
pH_sacn2.0_season <- show_prdseason(pH_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

pH_metc0.3 <- wqdat |> filter(param == "pH") |> filter(station == "METC_0.3")
pH_mod0.3 <- anlz_gam(pH_metc0.3)
anlz_smooth(pH_mod0.3)
anlz_fit(pH_mod0.3)
pH_metc0.3_doy <- show_prddoy(pH_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
pH_metc0.3_series <- show_prdseries(pH_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
pH_metc0.3_season <- show_prdseason(pH_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

pH_doy <- arrangeGrob(pH_metc23.3_doy, pH_sacn20.0_doy, pH_sacn15.8_doy, pH_sacn2.0_doy, pH_metc0.3_doy, ncol = 1)
pH_series <- arrangeGrob(pH_metc23.3_series, pH_sacn20.0_series, pH_sacn15.8_series, pH_sacn2.0_series, pH_metc0.3_series, ncol = 1)
pH_season <- arrangeGrob(pH_metc23.3_season, pH_sacn20.0_season, pH_sacn15.8_season, pH_sacn2.0_season, pH_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk106, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(pH_doy)
```

###### Month by year {.tabset}
```{r chnk107, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(pH_season)
```

###### Full time series {.tabset}
```{r chnk108, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(pH_series)
```

##### SO4_mgL {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk113, results = 'hide'}
ylabel = "Sulfate (mg/L)"
so4_metc23.3 <- wqdat |> filter(param == "SO4_mgL") |> filter(station == "METC_23.3")
so4_mod23.3 <- anlz_gam(so4_metc23.3)
anlz_smooth(so4_mod23.3)
anlz_fit(so4_mod23.3)
so4_metc23.3_doy <- show_prddoy(so4_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
so4_metc23.3_series <- show_prdseries(so4_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
so4_metc23.3_season <- show_prdseason(so4_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

so4_sacn20.0 <- wqdat |> filter(param == "SO4_mgL") |> filter(station == "SACN_20.0")
so4_mod20.0 <- anlz_gam(so4_sacn20.0)
anlz_smooth(so4_mod20.0)
anlz_fit(so4_mod20.0)
so4_sacn20.0_doy <- show_prddoy(so4_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
so4_sacn20.0_series <- show_prdseries(so4_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
so4_sacn20.0_season <- show_prdseason(so4_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

so4_sacn15.8 <- wqdat |> filter(param == "SO4_mgL") |> filter(station == "SACN_15.8")
so4_mod15.8 <- anlz_gam(so4_sacn15.8)
anlz_smooth(so4_mod15.8)
anlz_fit(so4_mod15.8)
so4_sacn15.8_doy <- show_prddoy(so4_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
so4_sacn15.8_series <- show_prdseries(so4_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
so4_sacn15.8_season <- show_prdseason(so4_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

so4_sacn2.0 <- wqdat |> filter(param == "SO4_mgL") |> filter(station == "SACN_2.0")
so4_mod2.0 <- anlz_gam(so4_sacn2.0)
anlz_smooth(so4_mod2.0)
anlz_fit(so4_mod2.0)
so4_sacn2.0_doy <- show_prddoy(so4_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
so4_sacn2.0_series <- show_prdseries(so4_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
so4_sacn2.0_season <- show_prdseason(so4_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

so4_metc0.3 <- wqdat |> filter(param == "SO4_mgL") |> filter(station == "METC_0.3")
so4_mod0.3 <- anlz_gam(so4_metc0.3)
anlz_smooth(so4_mod0.3)
anlz_fit(so4_mod0.3)
so4_metc0.3_doy <- show_prddoy(so4_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
so4_metc0.3_series <- show_prdseries(so4_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
so4_metc0.3_season <- show_prdseason(so4_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

so4_doy <- arrangeGrob(so4_metc23.3_doy, so4_sacn20.0_doy, so4_sacn15.8_doy, so4_sacn2.0_doy, so4_metc0.3_doy, ncol = 1)
so4_series <- arrangeGrob(so4_metc23.3_series, so4_sacn20.0_series, so4_sacn15.8_series, so4_sacn2.0_series, so4_metc0.3_series, ncol = 1)
so4_season <- arrangeGrob(so4_metc23.3_season, so4_sacn20.0_season, so4_sacn15.8_season, so4_sacn2.0_season, so4_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk114, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(so4_doy)
```
 
###### Month by year {.tabset}
```{r chnk115, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(so4_season)
```

###### Full time series {.tabset}
```{r chnk116, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(so4_series)
```

##### SpecCond_uScm {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk117, results = 'hide'}
ylabel = "Specific Conductance (uScm)"
spec_metc23.3 <- wqdat |> filter(param == "SpecCond_uScm") |> filter(station == "METC_23.3")
spec_mod23.3 <- anlz_gam(spec_metc23.3)
anlz_smooth(spec_mod23.3)
anlz_fit(spec_mod23.3)
spec_metc23.3_doy <- show_prddoy(spec_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
spec_metc23.3_series <- show_prdseries(spec_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
spec_metc23.3_season <- show_prdseason(spec_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

spec_sacn20.0 <- wqdat |> filter(param == "SpecCond_uScm") |> filter(station == "SACN_20.0")
spec_mod20.0 <- anlz_gam(spec_sacn20.0)
anlz_smooth(spec_mod20.0)
anlz_fit(spec_mod20.0)
spec_sacn20.0_doy <- show_prddoy(spec_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
spec_sacn20.0_series <- show_prdseries(spec_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
spec_sacn20.0_season <- show_prdseason(spec_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

spec_sacn15.8 <- wqdat |> filter(param == "SpecCond_uScm") |> filter(station == "SACN_15.8")
spec_mod15.8 <- anlz_gam(spec_sacn15.8)
anlz_smooth(spec_mod15.8)
anlz_fit(spec_mod15.8)
spec_sacn15.8_doy <- show_prddoy(spec_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
spec_sacn15.8_series <- show_prdseries(spec_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
spec_sacn15.8_season <- show_prdseason(spec_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

spec_sacn2.0 <- wqdat |> filter(param == "SpecCond_uScm") |> filter(station == "SACN_2.0")
spec_mod2.0 <- anlz_gam(spec_sacn2.0)
anlz_smooth(spec_mod2.0)
anlz_fit(spec_mod2.0)
spec_sacn2.0_doy <- show_prddoy(spec_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
spec_sacn2.0_series <- show_prdseries(spec_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
spec_sacn2.0_season <- show_prdseason(spec_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

spec_metc0.3 <- wqdat |> filter(param == "SpecCond_uScm") |> filter(station == "METC_0.3")
spec_mod0.3 <- anlz_gam(spec_metc0.3)
anlz_smooth(spec_mod0.3)
anlz_fit(spec_mod0.3)
spec_metc0.3_doy <- show_prddoy(spec_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
spec_metc0.3_series <- show_prdseries(spec_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
spec_metc0.3_season <- show_prdseason(spec_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

spec_doy <- arrangeGrob(spec_metc23.3_doy, spec_sacn20.0_doy, spec_sacn15.8_doy, spec_sacn2.0_doy, spec_metc0.3_doy, ncol = 1)
spec_series <- arrangeGrob(spec_metc23.3_series, spec_sacn20.0_series, spec_sacn15.8_series, spec_sacn2.0_series, spec_metc0.3_series, ncol = 1)
spec_season <- arrangeGrob(spec_metc23.3_season, spec_sacn20.0_season, spec_sacn15.8_season, spec_sacn2.0_season, spec_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk118, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(spec_doy)
```

###### Month by year {.tabset}
```{r chnk119, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(spec_season)
```

###### Full time series {.tabset}
```{r chnk120, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(spec_series)
```

##### TempWater_C {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk121, results = 'hide'}
ylabel = "Water Temperature (C)"
wtmp_metc23.3 <- wqdat |> filter(param == "TempWater_C") |> filter(station == "METC_23.3")
wtmp_mod23.3 <- anlz_gam(wtmp_metc23.3)
anlz_smooth(wtmp_mod23.3)
anlz_fit(wtmp_mod23.3)
wtmp_metc23.3_doy <- show_prddoy(wtmp_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
wtmp_metc23.3_series <- show_prdseries(wtmp_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
wtmp_metc23.3_season <- show_prdseason(wtmp_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

wtmp_sacn20.0 <- wqdat |> filter(param == "TempWater_C") |> filter(station == "SACN_20.0")
wtmp_mod20.0 <- anlz_gam(wtmp_sacn20.0)
anlz_smooth(wtmp_mod20.0)
anlz_fit(wtmp_mod20.0)
wtmp_sacn20.0_doy <- show_prddoy(wtmp_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
wtmp_sacn20.0_series <- show_prdseries(wtmp_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
wtmp_sacn20.0_season <- show_prdseason(wtmp_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

wtmp_sacn15.8 <- wqdat |> filter(param == "TempWater_C") |> filter(station == "SACN_15.8")
wtmp_mod15.8 <- anlz_gam(wtmp_sacn15.8)
anlz_smooth(wtmp_mod15.8)
anlz_fit(wtmp_mod15.8)
wtmp_sacn15.8_doy <- show_prddoy(wtmp_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
wtmp_sacn15.8_series <- show_prdseries(wtmp_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
wtmp_sacn15.8_season <- show_prdseason(wtmp_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

wtmp_sacn2.0 <- wqdat |> filter(param == "TempWater_C") |> filter(station == "SACN_2.0")
wtmp_mod2.0 <- anlz_gam(wtmp_sacn2.0)
anlz_smooth(wtmp_mod2.0)
anlz_fit(wtmp_mod2.0)
wtmp_sacn2.0_doy <- show_prddoy(wtmp_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
wtmp_sacn2.0_series <- show_prdseries(wtmp_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
wtmp_sacn2.0_season <- show_prdseason(wtmp_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

wtmp_metc0.3 <- wqdat |> filter(param == "TempWater_C") |> filter(station == "METC_0.3")
wtmp_mod0.3 <- anlz_gam(wtmp_metc0.3)
anlz_smooth(wtmp_mod0.3)
anlz_fit(wtmp_mod0.3)
wtmp_metc0.3_doy <- show_prddoy(wtmp_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
wtmp_metc0.3_series <- show_prdseries(wtmp_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
wtmp_metc0.3_season <- show_prdseason(wtmp_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

wtmp_doy <- arrangeGrob(wtmp_metc23.3_doy, wtmp_sacn20.0_doy, wtmp_sacn15.8_doy, wtmp_sacn2.0_doy, wtmp_metc0.3_doy, ncol = 1)
wtmp_series <- arrangeGrob(wtmp_metc23.3_series, wtmp_sacn20.0_series, wtmp_sacn15.8_series, wtmp_sacn2.0_series, wtmp_metc0.3_series, ncol = 1)
wtmp_season <- arrangeGrob(wtmp_metc23.3_season, wtmp_sacn20.0_season, wtmp_sacn15.8_season, wtmp_sacn2.0_season, wtmp_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk122, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(wtmp_doy)
```

###### Month by year {.tabset}
```{r chnk123, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(wtmp_season)
```

###### Full time series {.tabset}
```{r chnk124, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(wtmp_series)
```


##### TSS_mgL {.tabset}
<div class = "toggle"><button>Show Code</button>
```{r chnk125, results = 'hide'}
ylabel = "Total Suspended Solids"
tss_metc23.3 <- wqdat |> filter(param == "TSS_mgL") |> filter(station == "METC_23.3")
tss_mod23.3 <- anlz_gam(tss_metc23.3)
anlz_smooth(tss_mod23.3)
anlz_fit(tss_mod23.3)
tss_metc23.3_doy <- show_prddoy(tss_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
tss_metc23.3_series <- show_prdseries(tss_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
tss_metc23.3_season <- show_prdseason(tss_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

tss_sacn20.0 <- wqdat |> filter(param == "TSS_mgL") |> filter(station == "SACN_20.0")
tss_mod20.0 <- anlz_gam(tss_sacn20.0)
anlz_smooth(tss_mod20.0)
anlz_fit(tss_mod20.0)
tss_sacn20.0_doy <- show_prddoy(tss_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
tss_sacn20.0_series <- show_prdseries(tss_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
tss_sacn20.0_season <- show_prdseason(tss_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

tss_sacn15.8 <- wqdat |> filter(param == "TSS_mgL") |> filter(station == "SACN_15.8")
tss_mod15.8 <- anlz_gam(tss_sacn15.8)
anlz_smooth(tss_mod15.8)
anlz_fit(tss_mod15.8)
tss_sacn15.8_doy <- show_prddoy(tss_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
tss_sacn15.8_series <- show_prdseries(tss_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
tss_sacn15.8_season <- show_prdseason(tss_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

tss_sacn2.0 <- wqdat |> filter(param == "TSS_mgL") |> filter(station == "SACN_2.0")
tss_mod2.0 <- anlz_gam(tss_sacn2.0)
anlz_smooth(tss_mod2.0)
anlz_fit(tss_mod2.0)
tss_sacn2.0_doy <- show_prddoy(tss_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
tss_sacn2.0_series <- show_prdseries(tss_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
tss_sacn2.0_season <- show_prdseason(tss_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

tss_metc0.3 <- wqdat |> filter(param == "TSS_mgL") |> filter(station == "METC_0.3")
tss_mod0.3 <- anlz_gam(tss_metc0.3)
anlz_smooth(tss_mod0.3)
anlz_fit(tss_mod0.3)
tss_metc0.3_doy <- show_prddoy(tss_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
tss_metc0.3_series <- show_prdseries(tss_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
tss_metc0.3_season <- show_prdseason(tss_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

tss_doy <- arrangeGrob(tss_metc23.3_doy, tss_sacn20.0_doy, tss_sacn15.8_doy, tss_sacn2.0_doy, tss_metc0.3_doy, ncol = 1)
tss_series <- arrangeGrob(tss_metc23.3_series, tss_sacn20.0_series, tss_sacn15.8_series, tss_sacn2.0_series, tss_metc0.3_series, ncol = 1)
tss_season <- arrangeGrob(tss_metc23.3_season, tss_sacn20.0_season, tss_sacn15.8_season, tss_sacn2.0_season, tss_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk126, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(tss_doy)
```

###### Month by year {.tabset}
```{r chnk127, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(tss_season)
```

###### Full time series {.tabset}
```{r chnk128, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(tss_series)
```


##### Alkalinity_mgL {.tabset}
Putting last because METC added in 2016
<div class = "toggle"><button>Show Code</button>
```{r chnk129, results = 'hide'}
ylabel = "Alkalinity (mg/L)"
alk_metc23.3 <- wqdat |> filter(param == "Alkalinity_mgL") |> filter(station == "METC_23.3")
alk_mod23.3 <- anlz_gam(alk_metc23.3)
anlz_smooth(alk_mod23.3)
anlz_fit(alk_mod23.3)
alk_metc23.3_doy <- show_prddoy(alk_mod23.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
alk_metc23.3_series <- show_prdseries(alk_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')
alk_metc23.3_season <- show_prdseason(alk_mod23.3, ylab = ylabel) + labs(title = "Site: METC_23.3") + theme(legend.position = 'none')

alk_sacn20.0 <- wqdat |> filter(param == "Alkalinity_mgL") |> filter(station == "SACN_20.0")
alk_mod20.0 <- anlz_gam(alk_sacn20.0)
anlz_smooth(alk_mod20.0)
anlz_fit(alk_mod20.0)
alk_sacn20.0_doy <- show_prddoy(alk_mod20.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
alk_sacn20.0_series <- show_prdseries(alk_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')
alk_sacn20.0_season <- show_prdseason(alk_mod20.0, ylab = ylabel) + labs(title = "Site: SACN_20.0") + theme(legend.position = 'none')

alk_sacn15.8 <- wqdat |> filter(param == "Alkalinity_mgL") |> filter(station == "SACN_15.8")
alk_mod15.8 <- anlz_gam(alk_sacn15.8)
anlz_smooth(alk_mod15.8)
anlz_fit(alk_mod15.8)
alk_sacn15.8_doy <- show_prddoy(alk_mod15.8, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
alk_sacn15.8_series <- show_prdseries(alk_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')
alk_sacn15.8_season <- show_prdseason(alk_mod15.8, ylab = ylabel) + labs(title = "Site: SACN_15.8") + theme(legend.position = 'none')

alk_sacn2.0 <- wqdat |> filter(param == "Alkalinity_mgL") |> filter(station == "SACN_2.0")
alk_mod2.0 <- anlz_gam(alk_sacn2.0)
anlz_smooth(alk_mod2.0)
anlz_fit(alk_mod2.0)
alk_sacn2.0_doy <- show_prddoy(alk_mod2.0, ylab = ylabel, size = 1.5) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
alk_sacn2.0_series <- show_prdseries(alk_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')
alk_sacn2.0_season <- show_prdseason(alk_mod2.0, ylab = ylabel) + labs(title = "Site: SACN_2.0") + theme(legend.position = 'none')

alk_metc0.3 <- wqdat |> filter(param == "Alkalinity_mgL") |> filter(station == "METC_0.3")
alk_mod0.3 <- anlz_gam(alk_metc0.3)
anlz_smooth(alk_mod0.3)
anlz_fit(alk_mod0.3)
alk_metc0.3_doy <- show_prddoy(alk_mod0.3, ylab = ylabel, size = 1.5) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
alk_metc0.3_series <- show_prdseries(alk_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')
alk_metc0.3_season <- show_prdseason(alk_mod0.3, ylab = ylabel) + labs(title = "Site: METC_0.3") + theme(legend.position = 'bottom')

alk_doy <- arrangeGrob(alk_metc23.3_doy, alk_sacn20.0_doy, alk_sacn15.8_doy, alk_sacn2.0_doy, alk_metc0.3_doy, ncol = 1)
alk_series <- arrangeGrob(alk_metc23.3_series, alk_sacn20.0_series, alk_sacn15.8_series, alk_sacn2.0_series, alk_metc0.3_series, ncol = 1)
alk_season <- arrangeGrob(alk_metc23.3_season, alk_sacn20.0_season, alk_sacn15.8_season, alk_sacn2.0_season, alk_metc0.3_season, ncol = 1)
```
</div><br>

###### Day of year by year {.tabset}
```{r chnk130, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM by day of year."}
grid.draw(alk_doy)
```

###### Month by year {.tabset}
```{r chnk131, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM month by year."}
grid.draw(alk_season)
```

###### Full time series {.tabset}
```{r chnk132, echo = F, fig.height = 12, fig.width=8, fig.cap = "GAM full time series."}
grid.draw(alk_series)
```

#### Profile Plots {.tabset}
```{r lake_prof1, echo = F, out.width = "100%", eval = F, fig.height = 10, fig.cap = "Lake plot of parameter by sample depth in 1m bins."}
prof_p <- plotLakeProfile(site = lk_site, parameter = prm, color_rev = cr)
print(prof_p)
```

##### Site by years {.tabset}
```{r results = 'asis', fig.height = 10, fig.width = 9, echo = F}
colrev = c(T, T, F, F, F)

prof_list <- c("DO_mgL", "DOsat_pct", "pH", "SpecCond_uScm", "TempWater_C")
for(i in seq_along(prof_list)){
  prm <- prof_list[[i]]
  cr <- colrev[[i]]
  cat("###### ", prm, "\n\n")
    for(j in seq_along(lksc)){
    lk_site = lksc[[j]]
    cat(paste0("<details open><summary class='drop'>", lk_site, "</summary>"))
    cat(paste0("Profile plot of <b>", prm, "</b> by sample depth in 1m bins with isothemerm indicated by black line (if present)."))
    <<lake_prof1>>
    cat("\n\n")
    cat("</details>", "\n\n")
    cat("\n\n")
  }
}

```

##### Years by sites {.tabset}
```{r lake_prof2, echo = F, out.width = "100%", eval = F, fig.height = 10, fig.cap = "Lake plot of parameter by sample depth in 1m bins."}
prof_p2 <- plotLakeProfile(site = lksc, parameter = prm, year = yr, color_rev = cr)
print(prof_p2)
```


```{r results = 'asis', fig.height = 10, fig.width = 9, echo = F}
year_range = range(full_dat$year)[1]:range(full_dat$year)[2]
colrev = c(T, T, F, F, F)

for(i in seq_along(prof_list)){
  prm <- prof_list[[i]]
  cr <- colrev[[i]]
  cat("###### ", prm, "\n\n")
    for(j in seq_along(year_range)){
    yr = year_range[[j]]
    cat(paste0("<details open><summary class='drop'>Year: ", yr, "</summary>"))
    cat(paste0("Profile plot of <b>", prm, "</b> by sample depth in 1m bins with isotherm indicated by black line (if present)."))
    <<lake_prof2>>
    cat("\n\n")
    cat("</details>", "\n\n")
    cat("\n\n")
  }
}



```



### Notes
Things to check on:
<ol>
<li>Depth not always recorded in GLKN data. Where not recorded, appears to be metrics that are only collected at one depth. Make sure this is true.</li>
<li>Consider changing ChlA-ugL, Nh4_ugL, NO2+NO3_ugL, P_ugL to mgL, because METC data are reported in mgL and only have 2 significant figures. Makes the data look discrete on a plot when it's really not.</li>
</ol>

<!-- javascript code for code folding -->
<script>
  $(".toggle").click(function() {
    $(this).toggleClass("open");
  });
</script>


